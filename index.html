<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Nilgiri Parishad Store</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f5f7fb}
  header{background:#0ea5e9;color:#fff;padding:14px 12px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap}
  header h1{margin:0;font-size:20px}
  .actions{display:flex;gap:8px;align-items:center}
  .btn{background:#0ea5e9;color:#fff;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
  .btn.secondary{background:#fff;color:#0ea5e9;border:1px solid #0ea5e9}
  .container{max-width:1100px;margin:18px auto;padding:12px;display:grid;grid-template-columns:1fr 360px;gap:16px}
  .card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.04)}
  .notice{background:#fff3cd;border:1px solid #ffe8a1;padding:10px;border-radius:8px;margin-bottom:12px}
  .title{ text-align:center; margin:12px 0 }
  .title h2{color:#ff5722;margin:0;font-size:22px}
  .title p{margin:6px 0;color:#333}
  #productList{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
  .prod{border:1px solid #eee;border-radius:8px;padding:12px;display:flex;flex-direction:column;gap:8px}
  .imgwrap{height:140px;border-radius:6px;overflow:hidden;background:#f1f5f9;display:flex;align-items:center;justify-content:center}
  .imgwrap img{width:100%;height:100%;object-fit:cover}
  .muted{color:#666;font-size:13px}
  .qty{display:flex;align-items:center;gap:8px}
  .qty button{padding:6px 8px;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer}
  #cartModal{position:fixed;left:0;right:0;top:0;bottom:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:999}
  #cartBox{background:#fff;width:95%;max-width:700px;padding:12px;border-radius:8px;max-height:80vh;overflow:auto}
  footer{padding:12px;text-align:center;color:#666;margin-top:18px}
  .status-pill{padding:6px 10px;border-radius:20px;font-size:13px}
  .status-pending{background:#fff4e6;color:#92400e}
  .status-delivered{background:#ecfccb;color:#365314}
  .status-cancel{background:#fee2e2;color:#991b1b}
  @media(max-width:900px){ .container{grid-template-columns:1fr} header{justify-content:center} }
</style>
</head>
<body>

<header>
  <div>
    <strong>Nilgiri Parishad Local Store</strong>
  </div>
  <div class="actions">
    <button id="shareSite" class="btn secondary">Share</button>
    <button id="btnCart" class="btn">Cart (<span id="cartCount">0</span>)</button>
    <button id="btnOrders" class="btn secondary">‡§Æ‡•á‡§∞‡•á ‡§ë‡§∞‡•ç‡§°‡§∞</button>
    <button id="btnAdmin" class="btn secondary">Admin</button>
    <button id="btnLogout" class="btn" style="background:#ef4444">Logout</button>
  </div>
</header>

<div class="container">
  <div>
    <div id="noticeArea"></div>

    <div class="title">
      <h2>üõí ‡§§‡§æ‡§ú‡§º‡§æ ‡§î‡§∞ ‡§≠‡§∞‡•ã‡§∏‡•á‡§Æ‡§Ç‡§¶ ‡§∏‡§æ‡§Æ‡§æ‡§® ‚Äî ‡§∏‡•Ä‡§ß‡•á ‡§Ü‡§™‡§ï‡•á ‡§ò‡§∞ ‡§§‡§ï</h2>
      <p>Nilgiri Parishad ‡§ï‡•á ‡§≤‡§ø‡§è ‡§§‡•á‡§ú‡§º ‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä, ‡§≠‡§∞‡•ã‡§∏‡•á‡§Æ‡§Ç‡§¶ ‡§ï‡•ç‡§µ‡§æ‡§≤‡§ø‡§ü‡•Ä ‡§î‡§∞ ‡§∏‡•ç‡§•‡§æ‡§®‡•Ä‡§Ø ‡§¶‡§æ‡§Æ‡•§ ‡§®‡•Ä‡§ö‡•á ‡§∏‡•á ‡§ö‡•Å‡§®‡•á‡§Ç, cart ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡•á‡§Ç ‡§î‡§∞ ‡§è‡§ï ‡§∏‡§æ‡§• ‡§ë‡§∞‡•ç‡§°‡§∞ ‡§ï‡§∞‡•á‡§Ç‡•§</p>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Products</h3>
        <input id="search" placeholder="Search..." style="padding:8px;border-radius:8px;border:1px solid #ddd" />
      </div>
      <div id="productList" style="margin-top:12px"></div>
    </div>
  </div>

  <aside>
    <div class="card">
      <h4>‡§Ü‡§™‡§ï‡§æ ‡§™‡•ç‡§∞‡•ã‡§´‡§º‡§æ‡§á‡§≤</h4>
      <div id="profileArea" class="muted"></div>
    </div>

    <div class="card">
      <h4>Cart</h4>
      <div id="miniCart" class="muted">Cart empty</div>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button id="openCart" class="btn">Open Cart</button>
        <button id="btnCheckout" class="btn secondary">Checkout</button>
      </div>
    </div>
  </aside>
</div>

<!-- Cart Modal -->
<div id="cartModal">
  <div id="cartBox">
    <h3>‡§Ü‡§™‡§ï‡§æ Cart</h3>
    <div id="cartItems"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
      <div><strong>Total: ‚Çπ<span id="cartTotal">0</span></strong></div>
      <div style="display:flex;gap:8px">
        <button id="btnPlaceOrder" class="btn">Place Order (WhatsApp)</button>
        <button id="closeCart" class="btn secondary">Close</button>
      </div>
    </div>
  </div>
</div>

<footer>Demo ‚Ä¢ Data browser ‡§Æ‡•á‡§Ç saved (localStorage). Live sync ‡§ö‡§æ‡§π‡§ø‡§Ø‡•á ‡§§‡•ã Firebase ‡§ú‡•ã‡§°‡§º‡§®‡§æ ‡§π‡•ã‡§ó‡§æ.</footer>

<script>
/* CONFIG */
const OWNER_WHATSAPP = '+917089955265';
const ADMIN_PAGE = 'admin.html';
const K_PRODUCTS = 'np_products_v7';
const K_ORDERS = 'np_orders_v7';
const K_USER = 'np_user';
const K_NOTICE = 'np_notice_v1';
const K_CART = 'np_cart_v7';

/* INIT sample products if none */
if(!localStorage.getItem(K_PRODUCTS)){
  const sample = [
    { id:'p1', title:'Samosa (1 pc)', price:20, category:'Snacks', image:'https://i.ibb.co/4pDNDk1/sample-product.jpg', description:'Garam, crispy samosa ‚Äî ‡§ò‡§∞ ‡§ú‡•à‡§∏‡§æ ‡§∏‡•ç‡§µ‡§æ‡§¶.' },
    { id:'p2', title:'Fresh Milk 1L', price:60, category:'Dairy', image:'', description:'Fresh milk from local farm.' },
    { id:'p3', title:'Bread (1 loaf)', price:35, category:'Bakery', image:'', description:'Soft & fresh daily-baked bread.' }
  ];
  localStorage.setItem(K_PRODUCTS, JSON.stringify(sample));
}

/* HELPERS */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const load = k => JSON.parse(localStorage.getItem(k) || 'null');
const save = (k,v) => localStorage.setItem(k, JSON.stringify(v));
const uid = ()=> 'id'+Date.now().toString(36);

/* STATE */
let user = load(K_USER);
if(!user){ window.location.href = 'register.html'; }
let products = load(K_PRODUCTS) || [];
let orders = load(K_ORDERS) || [];
let notice = localStorage.getItem(K_NOTICE) || '';
let cart = load(K_CART) || [];

/* RENDER FUNCTIONS */
function renderNotice(){
  notice = localStorage.getItem(K_NOTICE) || '';
  if(notice){ $('#noticeArea').innerHTML = `<div class="notice"><strong>Notice:</strong> ${escapeHtml(notice)}</div>`; }
  else $('#noticeArea').innerHTML = '';
}
function renderProfile(){
  user = load(K_USER);
  $('#profileArea').innerHTML = user ? `<strong>${escapeHtml(user.name)}</strong><div class="muted">Mobile: ${escapeHtml(user.mobile)}</div><div class="muted">Block: ${escapeHtml(user.block)} | Flat: ${escapeHtml(user.flat)}</div>` : 'Not logged';
}
function renderProducts(){
  products = load(K_PRODUCTS) || [];
  const q = $('#search').value.trim().toLowerCase();
  const list = products.filter(p=> {
    if(!q) return true;
    return (p.title||'').toLowerCase().includes(q) || (p.description||'').toLowerCase().includes(q) || (p.category||'').toLowerCase().includes(q);
  });
  const container = $('#productList'); container.innerHTML = '';
  if(list.length===0){ container.innerHTML = '<div class="muted">‡§ï‡•ã‡§à product ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§</div>'; return; }
  list.forEach(p=>{
    const div = document.createElement('div'); div.className='prod';
    const imgHtml = p.image ? `<img src="${p.image}" alt="${escapeHtml(p.title)}">` : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#999">No Image</div>`;
    div.innerHTML = `<div class="imgwrap">${imgHtml}</div>
      <div><strong>${escapeHtml(p.title)}</strong></div>
      <div class="muted">‚Çπ${p.price} ‚Ä¢ ${escapeHtml(p.category||'General')}</div>
      <div class="muted" style="font-size:13px">${escapeHtml(p.description||'')}</div>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="qty">
          <button data-id="${p.id}" class="dec">-</button>
          <div style="min-width:36px;text-align:center" data-qty="${p.id}">1</div>
          <button data-id="${p.id}" class="inc">+</button>
        </div>
        <div>
          <button class="btn add-cart" data-id="${p.id}">Add to Cart</button>
        </div>
      </div>`;
    container.appendChild(div);
  });
  $$('.inc').forEach(b=> b.onclick = ()=> { const id=b.dataset.id; changeQty(id, +1); });
  $$('.dec').forEach(b=> b.onclick = ()=> { const id=b.dataset.id; changeQty(id, -1); });
  $$('.add-cart').forEach(b=> b.onclick = ()=> { addToCart(b.dataset.id); });
}
function changeQty(pid, delta){
  const el = document.querySelector(`[data-qty="${pid}"]`);
  if(!el) return;
  let v = parseInt(el.innerText) || 1; v = Math.max(1, v + delta); el.innerText = v;
}

/* CART */
function addToCart(pid){
  const p = (load(K_PRODUCTS)||[]).find(x=>x.id===pid);
  if(!p) return alert('Product not found');
  const qtyEl = document.querySelector(`[data-qty="${pid}"]`);
  const qty = qtyEl ? parseInt(qtyEl.innerText) || 1 : 1;
  const existing = cart.find(c=>c.id===pid);
  if(existing) existing.qty += qty;
  else cart.push({ id:p.id, title:p.title, price:p.price, qty });
  save(K_CART, cart);
  renderCartMini(); updateCartCount();
  alert(`${p.title} cart ‡§Æ‡•á‡§Ç add ‡§π‡•Å‡§Ü (${qty}).`);
}
function renderCartMini(){
  cart = load(K_CART) || [];
  $('#miniCart').innerText = cart.length ? cart.map(c=>`${c.title} x ${c.qty} ‚Ä¢ ‚Çπ${c.price*c.qty}`).join('\n') : 'Cart empty';
}
function updateCartCount(){ cart = load(K_CART) || []; $('#cartCount').innerText = cart.reduce((s,i)=>s+i.qty,0); }

$('#btnCart').addEventListener('click', ()=> openCartModal());
$('#openCart').addEventListener('click', ()=> openCartModal());
function openCartModal(){ renderCartModal(); $('#cartModal').style.display='flex'; }
$('#closeCart').addEventListener('click', ()=> { $('#cartModal').style.display='none'; });

function renderCartModal(){
  const node = $('#cartItems'); node.innerHTML = ''; cart = load(K_CART) || [];
  if(cart.length===0){ node.innerHTML = '<div class="muted">Cart empty</div>'; $('#cartTotal').innerText='0'; return; }
  cart.forEach((c, idx)=>{
    const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='8px 0';
    row.innerHTML = `<div><strong>${escapeHtml(c.title)}</strong><div class="muted">‚Çπ${c.price} x ${c.qty}</div></div>
      <div style="display:flex;gap:8px;align-items:center">
        <button onclick="cartInc(${idx})" class="btn secondary">+</button>
        <button onclick="cartDec(${idx})" class="btn secondary">-</button>
        <button onclick="cartRemove(${idx})" style="background:#ef4444;color:#fff;border:none;padding:6px 8px;border-radius:6px">Remove</button>
      </div>`;
    node.appendChild(row);
  });
  const total = cart.reduce((s,i)=>s + i.price * i.qty, 0);
  $('#cartTotal').innerText = total.toFixed(2);
}
function cartInc(i){ cart = load(K_CART)||[]; cart[i].qty++; save(K_CART, cart); renderCartModal(); renderCartMini(); updateCartCount(); }
function cartDec(i){ cart = load(K_CART)||[]; cart[i].qty = Math.max(1, cart[i].qty-1); save(K_CART, cart); renderCartModal(); renderCartMini(); updateCartCount(); }
function cartRemove(i){ cart = load(K_CART)||[]; cart.splice(i,1); save(K_CART, cart); renderCartModal(); renderCartMini(); updateCartCount(); }

/* PLACE ORDER (cart -> single order with items & status 'Pending') */
$('#btnPlaceOrder').addEventListener('click', ()=> {
  cart = load(K_CART) || [];
  if(cart.length===0) return alert('Cart empty');
  user = load(K_USER);
  if(!user){ alert('Please register first'); window.location.href='register.html'; return; }
  const total = cart.reduce((s,i)=>s + i.price*i.qty, 0);
  const order = { id: uid(), name: user.name, mobile: user.mobile, block: user.block, flat: user.flat, items: cart, total, status:'Pending', createdAt: Date.now() };
  const all = load(K_ORDERS) || [];
  all.push(order); save(K_ORDERS, all);
  // clear cart
  cart = []; save(K_CART, cart);
  renderCartModal(); renderCartMini(); updateCartCount(); $('#cartModal').style.display='none';
  alert('Order placed. Owner ‡§ï‡•ã WhatsApp ‡§≠‡•á‡§ú‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à (pre-filled)‡•§');
  // WhatsApp message to owner
  const msg = `Order ID: ${order.id}%0AName: ${encodeURIComponent(order.name)}%0AMobile: ${encodeURIComponent(order.mobile)}%0ABlock: ${encodeURIComponent(order.block)}%0AFlat: ${encodeURIComponent(order.flat)}%0AItems:%0A${order.items.map(it=>encodeURIComponent(it.title)+' x'+it.qty).join('%0A')}%0ATotal: ‚Çπ${order.total}%0A%0A(Status:%20${order.status})`;
  const waUrl = `https://wa.me/${OWNER_WHATSAPP.replace(/\D/g,'')}?text=${msg}`;
  window.open(waUrl,'_blank');
});

/* Share site - WhatsApp share */
$('#shareSite').addEventListener('click', ()=> {
  const text = encodeURIComponent(`‡§¶‡•á‡§ñ‡•ã ‚Äî Nilgiri Parishad Store: ${location.href}\n‡§ò‡§∞ ‡§¨‡•à‡§†‡•á ‡§ë‡§∞‡•ç‡§°‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ñ‡•ã‡§≤‡•á‡§Ç.`);
  window.open(`https://wa.me/?text=${text}`,'_blank');
});

/* My Orders popup (shows user orders with status) */
$('#btnOrders').addEventListener('click', ()=> {
  user = load(K_USER);
  if(!user){ alert('Please register'); window.location.href='register.html'; return; }
  const all = load(K_ORDERS) || [];
  const my = all.filter(o=> o.mobile === user.mobile);
  let html = `<h3>‡§Æ‡•á‡§∞‡•á ‡§ë‡§∞‡•ç‡§°‡§∞</h3>`;
  if(my.length===0) html += '<div class="muted">‡§Ü‡§™‡§ï‡•á ‡§ï‡•ã‡§à ‡§ë‡§∞‡•ç‡§°‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡§Ç‡•§</div>';
  my.slice().reverse().forEach(o=> {
    html += `<div style="border:1px solid #eee;padding:10px;margin:8px 0;border-radius:8px"><strong>Order: ${o.id}</strong><div class="muted">${new Date(o.createdAt).toLocaleString()}</div><div style="margin-top:6px">${o.items.map(it=>escapeHtml(it.title)+' x'+it.qty).join('<br>')}</div><div style="margin-top:6px"><strong>‚Çπ${o.total}</strong></div><div style="margin-top:6px">${renderStatusHtml(o.status)}</div></div>`;
  });
  const w = window.open('','_blank'); w.document.write(html);
});

function renderStatusHtml(status){
  if(status === 'Pending') return `<span class="status-pill status-pending">Pending</span>`;
  if(status === 'Delivered') return `<span class="status-pill status-delivered">Delivered</span>`;
  if(status === 'Cancelled') return `<span class="status-pill status-cancel">Cancelled</span>`;
  return `<span class="status-pill">${escapeHtml(status)}</span>`;
}

/* admin / logout */
$('#btnAdmin').addEventListener('click', ()=> window.location.href = ADMIN_PAGE);
$('#btnLogout').addEventListener('click', ()=> { if(confirm('Logout ‡§ï‡§∞‡§®‡§æ ‡§π‡•à?')){ localStorage.removeItem(K_USER); window.location.href='register.html'; } });

/* search */
$('#search').addEventListener('input', renderProducts);

/* util */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

/* INIT render */
renderNotice(); renderProfile(); renderProducts(); renderCartMini(); updateCartCount();
</script>
</body>
</html>