<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin - Nilgiri Local Store</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f3f4f6;margin:0;padding:18px}
  .wrap{max-width:1100px;margin:0 auto}
  .card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.04);margin-bottom:12px}
  input,textarea,select{padding:8px;border-radius:6px;border:1px solid #ddd;width:100%;box-sizing:border-box;margin-top:6px}
  .row{display:flex;gap:8px}
  .row > *{flex:1}
  button{background:#0ea5e9;color:#fff;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
  .btn-muted{background:#fff;color:#0ea5e9;border:1px solid #0ea5e9}
  .muted{color:#666;font-size:13px}
  .prod-row{display:flex;gap:12px;align-items:center;padding:8px 0;border-bottom:1px solid #eee}
  .prod-row img{width:86px;height:56px;object-fit:cover;border-radius:6px}
  .actions{display:flex;gap:8px}
  .hide{display:none}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>Admin Login</h2>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="adminPass" placeholder="Admin password डालें" />
        <button id="adminLoginBtn">Login</button>
        <button id="backHome" class="btn-muted">Back Home</button>
      </div>
      <div class="muted" style="margin-top:6px">Only store owner/manager ke liye.</div>
    </div>

    <div id="adminArea" class="hide">
      <div class="card">
        <h3>Add / Edit Product</h3>
        <input id="pTitle" placeholder="Title" />
        <div class="row">
          <input id="pPrice" placeholder="Selling Price (₹)" />
          <input id="pCostPrice" placeholder="Cost Price (₹)" />
          <input id="pCategory" placeholder="Category" />
        </div>
        <input id="pImage" placeholder="Image URL" />
        <textarea id="pDesc" placeholder="Description"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="saveProductBtn">Save Product</button>
          <button id="resetForm" class="btn-muted">Reset Form</button>
        </div>
        <div class="muted" id="editInfo"></div>
      </div>

      <div class="card">
        <h3>Notice Board</h3>
        <textarea id="noticeText" style="width:100%;height:80px"></textarea>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="saveNotice">Save Notice</button>
          <button id="clearNotice" class="btn-muted">Clear Notice</button>
        </div>
      </div>

      <div class="card">
        <h3>Products</h3>
        <div id="productsList"></div>
      </div>
    </div>
  </div>

<script type="module">
  const ADMIN_PW = '5702';

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBRTrBG-AsNvUMmBb2vMePNvAspZfi3zOs",
    authDomain: "nilgiri-store.firebaseapp.com",
    projectId: "nilgiri-store",
    storageBucket: "nilgiri-store.firebasestorage.app",
    messagingSenderId: "556171236549",
    appId: "1:556171236549:web:5df5741c44ea8d9bfc8cac"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const $ = s => document.querySelector(s);
  const escapeHtml = s => s ? String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]) : '';

  $('#backHome').addEventListener('click', ()=> window.location.href='index.html');

  // Login gate
  $('#adminLoginBtn').addEventListener('click', ()=>{
    const pw = $('#adminPass').value || '';
    if(pw === ADMIN_PW){
      $('#adminArea').classList.remove('hide');
      subscribeProducts();
      loadNotice();
      alert('Admin logged in');
    } else alert('Wrong password');
  });

  /* ===== Products ===== */
  let editId = null;
  const productsRef = collection(db, 'products');

  function subscribeProducts(){
    onSnapshot(productsRef, (snap)=>{
      const list = snap.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=> (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
      renderProducts(list);
    });
  }

  function renderProducts(products){
    const node = $('#productsList'); node.innerHTML = '';
    if(!products.length){ node.innerHTML = '<div class="muted">No products</div>'; return; }
    products.forEach(p=>{
      const d = document.createElement('div'); d.className='prod-row';
      const img = p.image ? `<img src="${p.image}" />` : `<div style="width:86px;height:56px;background:#f1f5f9;border-radius:6px;display:flex;align-items:center;justify-content:center;color:#999">No Img</div>`;
      d.innerHTML = `${img}
        <div style="flex:1">
          <strong>${escapeHtml(p.title||'')}</strong>
          <div class="muted">Selling ₹${p.price||0} | Cost ₹${p.costPrice||0} • ${escapeHtml(p.category||'General')}</div>
          <div class="muted" style="margin-top:6px">${escapeHtml(p.description||'')}</div>
        </div>
        <div class="actions">
          <button data-id="${p.id}" class="btn-edit">Edit</button>
          <button data-id="${p.id}" class="btn-delete" style="background:#ef4444">Delete</button>
        </div>`;
      node.appendChild(d);
    });

    // attach actions
    node.querySelectorAll('.btn-edit').forEach(b=>{
      b.onclick = async ()=>{
        const id = b.getAttribute('data-id');
        editId = id;
        const ref = doc(db, 'products', id);
        const snap = await getDoc(ref);
        if(!snap.exists()) return alert('Not found');
        const p = snap.data();
        $('#pTitle').value = p.title||'';
        $('#pPrice').value = p.price||'';
        $('#pCostPrice').value = p.costPrice||'';
        $('#pCategory').value = p.category||'';
        $('#pImage').value = p.image||'';
        $('#pDesc').value = p.description||'';
        $('#editInfo').innerText = `Editing: ${id}`;
        window.scrollTo({top:0, behavior:'smooth'});
      }
    });
    node.querySelectorAll('.btn-delete').forEach(b=>{
      b.onclick = async ()=>{
        const id = b.getAttribute('data-id');
        if(!confirm('Delete product?')) return;
        await deleteDoc(doc(db,'products',id));
        if(editId===id){ resetForm(); }
      }
    });
  }

  function resetForm(){
    editId = null;
    $('#pTitle').value=''; $('#pPrice').value=''; $('#pCostPrice').value='';
    $('#pCategory').value=''; $('#pImage').value=''; $('#pDesc').value='';
    $('#editInfo').innerText='';
  }
  $('#resetForm').addEventListener('click', resetForm);

  $('#saveProductBtn').addEventListener('click', async ()=>{
    const t = $('#pTitle').value.trim();
    const pr = parseFloat($('#pPrice').value) || 0;
    const cp = parseFloat($('#pCostPrice').value) || 0;
    const cat = $('#pCategory').value.trim() || 'General';
    const img = $('#pImage').value.trim() || '';
    const desc = $('#pDesc').value.trim() || '';
    if(!t || !pr){ alert('Title और Selling Price डालें'); return; }

    const payload = { title:t, price:pr, costPrice:cp, category:cat, image:img, description:desc, updatedAt:serverTimestamp() };
    if(editId){
      await setDoc(doc(db,'products',editId), payload, {merge:true});
      alert('Product updated');
    } else {
      await addDoc(collection(db,'products'), { ...payload, createdAt:serverTimestamp() });
      alert('Product added');
    }
    resetForm();
  });

  /* ===== Notice ===== */
  const noticeRef = doc(db, 'config', 'notice');

  async function loadNotice(){
    const snap = await getDoc(noticeRef);
    $('#noticeText').value = snap.exists() ? (snap.data().text || '') : '';
  }

  $('#saveNotice').addEventListener('click', async ()=>{
    const text = $('#noticeText').value.trim();
    await setDoc(noticeRef, { text, updatedAt: serverTimestamp() }, { merge:true });
    alert('Notice saved');
  });

  $('#clearNotice').addEventListener('click', async ()=>{
    if(!confirm('Clear notice?')) return;
    await setDoc(noticeRef, { text: '' , updatedAt: serverTimestamp() }, { merge:true });
    $('#noticeText').value = '';
    alert('Notice cleared');
  });
</script>
</body>
</html>